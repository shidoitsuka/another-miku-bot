const { Canvas } = require("canvas-constructor");
const { resolve, join } = require("path");
const { MessageAttachment } = require("discord.js");
const { get } = require("snekfetch");
const fsn = require("fs-nextra");
const imageUrlRegex = /\?size=2048$/g;

exports.run = async (bot, message, args, prefix) => {
  // return message.channel.send("Under Maintenance.");
  const joined = args.join(" ").split(";");
  const first = joined[0];
  const second = joined[1];
  const third = joined[2];
  if (!joined[1])
    return message.channel.send(`Run \`${prefix}help drakepost\` UwU`);
  async function drake() {
    const { body: img } = await get("https://i.imgsafe.org/a9/a9f192a72b.png");
    const { body: avatar } = await get(
      message.author
        .displayAvatarURL({ format: "png", size: 2048 })
        .replace(imageUrlRegex, "?size=128")
    );
    return new Canvas(850, 550)
      .addImage(img, 0, 0, 850, 550)
      .setColor("#151515")
      .setTextAlign("center")
      .setTextFont("35px impact")
      .addResponsiveText(first, 590, 138, 505)
      .save()
      .addResponsiveText(second, 590, 413, 505)
      .restore()
      .save()
      .addRoundImage(avatar, 0, 0, 128, 128, 64)
      .restore()
      .addRoundImage(avatar, 160, 300, 128, 128, 64, 64)
      .toBufferAsync();
  }

  // STARTS HERE
  let now = Date.now();
  // let send;
  // joined[2] ? send = three() : send = two();
  message.channel.startTyping();
  message.channel.send("**Rendering...**").then(async m => {
    m.edit(`Rendered in \`${Date.now() - now}ms\``);
    m.edit("**Sending...**");
    await message.channel
      .send(
        new MessageAttachment(await drake(), `drake-${message.author.id}.jpg`)
      )
      .then(message.channel.stopTyping());
    m.delete();
  });
};

exports.conf = {
  aliases: ["drake"],
  cooldown: 3,
  guildOnly: false,
  userPerm: [""],
  botPerm: ["ATTACH_FILES"]
};

exports.help = {
  name: "drakepost",
  category: "Fun",
  description: "Make a drakepost comparison meme",
  usage: "drakepost <first-text>;<second-text>",
  param: ""
};
